name: Health Check

on:
  schedule:
    - cron: "*/15 * * * *" # Every 15 minutes
  workflow_dispatch:

jobs:
  health-check:
    name: ðŸ” Health Check (Production)
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: ðŸš‘ Run Health Check Script on VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -euo pipefail
            echo "ðŸ©º Starting health checks for ytclipper production"

            # 1. Check Docker services
            echo "ðŸ“¦ Checking Docker services..."
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

            # Check specific production containers
            echo "ðŸ” Checking production containers..."
            BACKEND_CONTAINER="ytclipper-production-backend"
            FRONTEND_CONTAINER="ytclipper-production-app"

            if [ "$(docker ps -q -f name=^${BACKEND_CONTAINER}$)" ]; then
              echo "âœ… Backend container ($BACKEND_CONTAINER) is running"
            else
              echo "âŒ Backend container ($BACKEND_CONTAINER) is not running"
              exit 1
            fi

            if [ "$(docker ps -q -f name=^${FRONTEND_CONTAINER}$)" ]; then
              echo "âœ… Frontend container ($FRONTEND_CONTAINER) is running"
            else
              echo "âŒ Frontend container ($FRONTEND_CONTAINER) is not running"
              exit 1
            fi

            # 2. Backend health check
            echo "ðŸ” Checking backend health at http://localhost:8080/health"
            if curl --fail --silent --max-time 5 http://localhost:8080/health; then
              echo "âœ… Backend is healthy"
            else
              echo "âŒ Backend health check failed"
              exit 1
            fi

            # 3. Database health check via backend endpoint
            echo "ðŸ˜ Checking database health at http://localhost:8080/db-health"
            if curl --fail --silent --max-time 5 http://localhost:8080/db-health; then
              echo "âœ… Database connection is healthy"
            else
              echo "âŒ Database health check failed"
              exit 1
            fi

            # 4. Frontend health check
            echo "ðŸŒ Checking frontend health at http://localhost:3000/"
            if curl --fail --silent --max-time 5 http://localhost:3000/; then
              echo "âœ… Frontend is healthy"
            else
              echo "âŒ Frontend health check failed"
              exit 1
            fi

            # 5. Check Docker port mappings
            echo "ðŸ”Œ Checking Docker port mappings..."
            BACKEND_PORTS=$(docker port $BACKEND_CONTAINER 2>/dev/null || echo "none")
            FRONTEND_PORTS=$(docker port $FRONTEND_CONTAINER 2>/dev/null || echo "none")

            echo "Backend ports: $BACKEND_PORTS"
            echo "Frontend ports: $FRONTEND_PORTS"

            if echo "$BACKEND_PORTS" | grep -q "8080"; then
              echo "âœ… Backend port mapping is active"
            else
              echo "âŒ Backend port mapping not found"
              exit 1
            fi

            if echo "$FRONTEND_PORTS" | grep -q "3000"; then
              echo "âœ… Frontend port mapping is active"
            else
              echo "âŒ Frontend port mapping not found"
              exit 1
            fi

            echo "ðŸ All checks passed!"

      - name: âœ… Health Check Summary
        if: success()
        run: |
          echo "## âœ… All Services Healthy" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ðŸŸ¢ Healthy" >> $GITHUB_STEP_SUMMARY
          echo "- Database: ðŸŸ¢ Healthy" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ðŸŸ¢ Healthy" >> $GITHUB_STEP_SUMMARY
          echo "- Port mappings: ðŸŸ¢ Active" >> $GITHUB_STEP_SUMMARY
          echo "- Last check: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: âŒ Alert on Failure
        if: failure()
        run: |
          echo "## âŒ Health Check Failed" >> $GITHUB_STEP_SUMMARY
          echo "- One or more services are **unhealthy**" >> $GITHUB_STEP_SUMMARY
          echo "- Failure time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "### Troubleshooting Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Check container status: \`docker ps -a\`" >> $GITHUB_STEP_SUMMARY
          echo "2. View backend logs: \`docker logs ytclipper-production-backend\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Check database connection: \`psql \$DATABASE_URL -c 'SELECT 1'\`" >> $GITHUB_STEP_SUMMARY
          echo "4. View frontend logs: \`docker logs ytclipper-production-app\`" >> $GITHUB_STEP_SUMMARY
          echo "5. Check Nginx status: \`sudo systemctl status nginx\`" >> $GITHUB_STEP_SUMMARY
          echo "6. Check port mappings: \`docker port ytclipper-production-backend && docker port ytclipper-production-app\`" >> $GITHUB_STEP_SUMMARY
